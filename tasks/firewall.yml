---
# Firewall Hardening Tasks

- name: Firewall | Ensure firewalld is installed
  ansible.builtin.package:
    name: firewalld
    state: present

- name: Firewall | Ensure firewalld is enabled and running
  ansible.builtin.service:
    name: firewalld
    state: started
    enabled: true

- name: Firewall | Set default zone
  ansible.builtin.command: "firewall-cmd --set-default-zone={{ firewall_default_zone }}"
  register: default_zone_result
  changed_when: "'ZONE_ALREADY_SET' not in default_zone_result.stderr"

- name: Firewall | Allow services
  ansible.posix.firewalld:
    service: "{{ item }}"
    permanent: true
    state: enabled
    immediate: true
    zone: "{{ firewall_default_zone }}"
  loop: "{{ firewall_allowed_services }}"
  when: firewall_allowed_services is defined

- name: Firewall | Allow specific ports
  ansible.posix.firewalld:
    port: "{{ item }}"
    permanent: true
    state: enabled
    immediate: true
    zone: "{{ firewall_default_zone }}"
  loop: "{{ firewall_allowed_ports }}"
  when: firewall_allowed_ports is defined

- name: Firewall | Block specific ports
  ansible.posix.firewalld:
    port: "{{ item }}"
    permanent: true
    state: disabled
    immediate: true
    zone: "{{ firewall_default_zone }}"
  loop: "{{ firewall_blocked_ports }}"
  when: firewall_blocked_ports is defined and firewall_blocked_ports | length > 0

- name: Firewall | Configure rich rules
  ansible.posix.firewalld:
    rich_rule: "{{ item }}"
    permanent: true
    state: enabled
    immediate: true
    zone: "{{ firewall_default_zone }}"
  loop: "{{ firewall_rich_rules }}"
  when: firewall_rich_rules is defined
  notify: Reload firewalld

- name: Firewall | Display configuration status
  ansible.builtin.debug:
    msg: "Firewall hardening completed - Default zone: {{ firewall_default_zone }}"
