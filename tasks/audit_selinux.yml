---
# SELinux Audit Tasks

- name: Audit SELinux | Check SELinux status
  ansible.builtin.command: getenforce
  register: selinux_current_mode
  changed_when: false
  failed_when: false

- name: Audit SELinux | Verify SELinux state
  ansible.builtin.set_fact:
    audit_results: >-
      {{ audit_results + ['[SELinux] State: Expected=' + selinux_state | upper +
      ', Current=' + selinux_current_mode.stdout + ' - ' +
      ('PASS' if selinux_current_mode.stdout | lower == selinux_state | lower else 'FAIL')] }}
    audit_violations: >-
      {{ audit_violations + ['SELinux state mismatch: Expected ' + selinux_state +
      ', Found ' + selinux_current_mode.stdout]
      if selinux_current_mode.stdout | lower != selinux_state | lower else audit_violations }}
  when: selinux_current_mode.rc == 0

- name: Audit SELinux | Check SELinux policy
  ansible.builtin.command: sestatus
  register: selinux_status
  changed_when: false
  failed_when: false

- name: Audit SELinux | Verify SELinux policy
  ansible.builtin.set_fact:
    policy_check: "{{ 'Policy from config file: ' + selinux_policy in selinux_status.stdout }}"
    audit_results: >-
      {{ audit_results + ['[SELinux] Policy: Expected=' + selinux_policy +
      ' - ' + ('PASS' if 'Policy from config file: ' + selinux_policy in selinux_status.stdout else 'FAIL')] }}
    audit_violations: >-
      {{ audit_violations + ['SELinux policy mismatch: Expected ' + selinux_policy]
      if 'Policy from config file: ' + selinux_policy not in selinux_status.stdout else audit_violations }}
  when: selinux_status.rc == 0

- name: Audit SELinux | Check SELinux booleans
  ansible.builtin.command: "getsebool {{ item.name }}"
  loop: "{{ selinux_booleans }}"
  register: selinux_booleans_check
  changed_when: false
  failed_when: false
  when: selinux_booleans is defined and selinux_booleans | length > 0

- name: Audit SELinux | Verify booleans configuration
  ansible.builtin.set_fact:
    audit_results: >-
      {{ audit_results + ['[SELinux Boolean] ' + item.item.name + ': ' +
      ('PASS' if item.item.state in item.stdout else 'FAIL')] }}
    audit_violations: >-
      {{ audit_violations + ['SELinux boolean ' + item.item.name +
      ' is not set to ' + item.item.state]
      if item.rc == 0 and item.item.state not in item.stdout else audit_violations }}
  loop: "{{ selinux_booleans_check.results }}"
  when:
    - selinux_booleans is defined
    - selinux_booleans_check.results is defined

- name: Audit SELinux | Check file contexts
  ansible.builtin.shell: |
    set -o pipefail
    ls -Zd {{ item.target | regex_replace('\\(.*\\)', '') }} 2>/dev/null | head -1
  args:
    executable: /bin/bash
  loop: "{{ selinux_file_contexts }}"
  register: selinux_contexts_check
  failed_when: false
  changed_when: false
  when: selinux_file_contexts is defined and selinux_file_contexts | length > 0

- name: Audit SELinux | Verify file context results
  ansible.builtin.set_fact:
    audit_results: >-
      {{ audit_results + ['[SELinux] File context for ' + item.item.target + ': ' +
      ('PASS' if item.rc == 0 and item.item.setype in item.stdout else 'FAIL - ' +
      (item.stdout if item.rc == 0 else 'Path not found'))] }}
    audit_violations: >-
      {{ audit_violations + ['SELinux: File context for ' + item.item.target +
      ' - expected ' + item.item.setype +
      (', found ' + item.stdout if item.rc == 0 else ', path not found')]
      if item.rc != 0 or item.item.setype not in item.stdout else audit_violations }}
  loop: "{{ selinux_contexts_check.results }}"
  when:
    - selinux_file_contexts is defined
    - selinux_contexts_check.results is defined

- name: Audit SELinux | Display audit results
  ansible.builtin.debug:
    msg: "SELinux audit completed - {{ audit_results | select('search', 'SELinux') | list | length }} checks performed"
