---
# DNF/Package Management Hardening Tasks

- name: DNF | Configure DNF security settings
  lineinfile:
    path: /etc/dnf/dnf.conf
    regexp: "^{{ item.key }}="
    line: "{{ item.key }}={{ item.value }}"
    state: present
    create: false
    backup: true
  loop: "{{ dnf_config | dict2items }}"
  when: dnf_config is defined

- name: DNF | Ensure dnf-automatic is installed
  package:
    name: dnf-automatic
    state: present
  when: dnf_automatic_enabled | bool

- name: DNF | Configure dnf-automatic
  lineinfile:
    path: /etc/dnf/automatic.conf
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    state: present
    backup: true
  loop:
    - { regexp: '^apply_updates =', line: 'apply_updates = {{ dnf_automatic_apply_updates | lower }}' }
    - { regexp: '^download_updates =', line: 'download_updates = {{ dnf_automatic_download_updates | lower }}' }
  when: dnf_automatic_enabled | bool

- name: DNF | Enable and start dnf-automatic timer
  systemd:
    name: dnf-automatic.timer
    enabled: true
    state: started
  when: dnf_automatic_enabled | bool

- name: DNF | Ensure required security packages are installed
  package:
    name: "{{ required_security_packages }}"
    state: present
  when: required_security_packages is defined

- name: DNF | Ensure prohibited packages are removed
  package:
    name: "{{ prohibited_packages }}"
    state: absent
  when: prohibited_packages is defined

- name: DNF | Check for available security updates
  command: dnf updateinfo list security --available
  register: security_updates
  changed_when: false
  failed_when: false

- name: DNF | Display available security updates
  debug:
    msg: "{{ security_updates.stdout_lines }}"
  when: security_updates.stdout_lines | length > 0

- name: DNF | Set fact for pending updates
  set_fact:
    pending_security_updates: "{{ security_updates.stdout_lines | length }}"

- name: DNF | Display configuration status
  debug:
    msg: "DNF hardening completed - Automatic updates: {{ dnf_automatic_enabled }}, Pending security updates: {{ pending_security_updates }}"
